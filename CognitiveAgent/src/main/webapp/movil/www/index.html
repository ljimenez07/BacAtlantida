<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-MPXB6S');</script>
	<!-- End Google Tag Manager -->
	<meta charset="UTF-8">
	<meta name="format-detection" content="telephone=no">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/custom.css">
	<script type="text/javascript" src="js/globals.js"></script>
	<title>Agente Cognitivo</title>
</head>
<body>
	<!-- Google Tag Manager (noscript) -->
	<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MPXB6S"
	height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
	<!-- End Google Tag Manager (noscript) -->
	
	<div id="modales">
		<div id="sesion-expirada" class="modal fade" style="display:none;"role="dialog">
			<div class="modal-dialog modal-sm" style="background-color: white;">
				<div class="modal-body">
					 Su sesión ha expirado
				</div>
				<div class="modal-footer">
					<div class="row">
						<div class="col-xs-12">
							<button data-after="quitarModalSesion()" class="btn btn-default clickable">Ok</button>
						</div>
					</div>
				</div>
			</div>		
		</div>
	</div>
	
	<div id="nuevasOfertas" class="modal fade" style=""role="dialog">
		<div class="modal-dialog modal-sm" style="background-color: white;">
			<div class="modal-body">
				Hay nuevas ofertas para ti! 
			</div>
			<div class="modal-footer">
				<div class="row">
					<div class="col-xs-12">
						<button data-href="conocerte" data-after="quitarModal()" class="btn btn-default clickable">Si</button>
					</div>
				</div>
			</div>
		</div>		
	</div>

	<div data-accion="ocultar-menu" class="modal modal-menu clickable" style="display: none">
		<div class="container menu" style="display: none;">
			<div data-href="conocerte" class="row clickable" id="menu-item-conocerte" style="display: none;">
				<div class="col-xs-2 contenedor-imagen-menu">
					<div class="icono-conocerme"></div>
				</div>
				<div class="col-xs-10 contenedor-texto-menu">
					<div>Conocerme</div>
				</div>
			</div>
			<div data-href="chat" class="row clickable">
				<div class="col-xs-2 contenedor-imagen-menu">
					<div class="icono-consultar"></div>
				</div>
				<div class="col-xs-10 contenedor-texto-menu">
					<div>Consultar</div>
				</div>
			</div>
			<div data-accion="salir" class="row clickable" id="menu-item-salir" style="display: none;">
				<div class="col-xs-2 contenedor-imagen-menu">
					<div class="icono-salir"></div>
				</div>
				<div class="col-xs-10 contenedor-texto-menu">
					<div>Salir</div>
				</div>
			</div>
		</div>
	</div>
	<div class="app">
		<div id="ofertas" class="show" ></div>
		<div id="oferta" class="hide" ></div>
		<div id="chat" class="hide"></div>
		<div id="conocerte" class="hide"></div>
		<div id="login" class="hide"></div>
	</div>
	<script type="text/javascript" src="cordova.js"></script>
	<script type="text/javascript" src="js/index.js"></script>
	<script type="text/javascript" src="js/angular.min.js"></script>
	<script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/handlebars-v4.0.5.js"></script>
	
	<script type="text/javascript" src="js/layout.handlebars.js"></script>
	<script type="text/javascript" src="js/ofertas.handlebars.js"></script>
	<script type="text/javascript" src="js/listaDeOfertas.handlebars.js"></script>
	<script type="text/javascript" src="js/oferta.handlebars.js"></script>
	<script type="text/javascript" src="js/chats.handlebars.js"></script>
	<script type="text/javascript" src="js/popupconocerte.handlebars.js"></script>
	<script type="text/javascript" src="js/login.handlebars.js"></script>
	
	<script>
	var audios = new Array();
	var audioEnReproduccion = null;
	var estaReproduciendo = false;
	var estaLogueado = false;
	var ventanaActual = "ofertas";
	
	var mensajesDeErrorEnAudio = ["", {code: 1, "message": "MEDIA_ERR_ABORTED"}, {code: 2, "message": "MEDIA_ERR_NETWORK"}, {code: 3, "message": "MEDIA_ERR_DECODE"}, {code: 4, "message": "MEDIA_ERR_SRC_NOT_SUPPORTED"}];
	
	function quitarModal()
	{
		setCookie('mostrarpopupdeconocerte', true, 100);
		$("#popupconocerte").modal('hide');
	}
	
	function quitarModalSesion()
	{
		$("#sesion-expirada").modal('hide');
		inicializarPantallas();
	}
	
	function cambiarVista(href)
	{
		audios = new Array();
		var app = $(".app");
		
		app.find(".show").hide();
		app.find("#"+href).show();
		
		app.find(".show").removeClass("show");
		app.find("#"+href).removeClass("hide");
		app.find("#"+href).addClass("show");
		
		var botonEscucharMensajes = $("#chat-id-" + href + " .boton-escuchar-mensajes");
		if(botonEscucharMensajes.hasClass("desactivado"))
		{
			botonEscucharMensajes.click();
		}
		
		if(href == "login")
		{
			$("body").css({"overflow": "hidden"});
		}
		else
		{
			$("body").css({"overflow": "scroll"});
			ventanaActual = href;
		}
	}
	
	function menu(accion)
	{
		if(accion == "mostrar-menu")
		{
			$(".modal-menu").fadeIn("fast");
			$(".menu").show("fast");
		}
		else if(accion == "ocultar-menu")
		{
			$(".menu").hide("fast");
			$(".modal-menu").fadeOut("fast");
		}
	}
	
	var pantallas = new Object();
	$(function()
	{
		pantallas["login"] = {title: "LOGIN", body: Handlebars.templates.login(), DebajoDelPanel: ""};
		var chat = {"pathDelServidor":"chat"};
		pantallas["chat"] = {title: "CHAT", body: '<div id="chat-id-'+chat.pathDelServidor+'"><ol id="conversation" class="chat" ></ol></div>', DebajoDelPanel: Handlebars.templates.chats(chat)};
		var conocerte = {"pathDelServidor":"conocerte"};
		pantallas["conocerte"] = {title: "CONOCERTE", body: '<div id="chat-id-'+conocerte.pathDelServidor+'"><ol id="conversation" class="chat" ></ol></div>', DebajoDelPanel: Handlebars.templates.chats(conocerte)};
		pantallas["popupconocerte"] ={};		
		pantallas["ofertas"] = {title: "INICIO", body: Handlebars.templates.ofertas(), DebajoDelPanel: ""};
		pantallas["oferta"] = {title: "DETALLE DE LA OFERTA", body: "", DebajoDelPanel: ""};
		
		inicializarPantallas();
		
		if(getCookie("mostrarpopupdeconocerte") == "")
		{
			$("#popupconocerte").modal('show');
		}	
		
		ajax({
			url: serverDomain + "/movil/usuario",
			done: function(data)
			{
				establecerBienvenida(data.estaLogueado, data.usuarioNombre);
			}
		});
	});
	
	function inicializarPantallas()
	{
		$(".app #ofertas").html(Handlebars.templates.layout(pantallas["ofertas"]));
		$(".app #oferta").html(Handlebars.templates.layout(pantallas["oferta"]));
		$("#modales").append(Handlebars.templates.popupconocerte(pantallas["popupconocerte"]));
		$(".app #chat").html(Handlebars.templates.layout(pantallas["chat"]));
		$(".app #conocerte").html(Handlebars.templates.layout(pantallas["conocerte"]));
		$(".app #login").html(Handlebars.templates.layout(pantallas["login"]));
		
		bindClickeable();
	}
	
	function establecerBienvenida(estaLogueado, nombreUsuario)
	{
		if(estaLogueado)
		{
			$("#ofertas .contenedor-de-mensaje-bienvenida").html("<p><strong>¡Hola " + nombreUsuario + "!</strong></p><br>");
			$("#ofertas .contenedor-de-ofertas").prepend('<div class="row"><div class="col-xs-12 text-center"><div class="top10">TOP 10</div><div class="beneficios">Sus mejores beneficios y ofertas</div><br></div</div>')
		}
	}

	function bindClickeable()
	{
		$(".clickable").off("click").on("click", function()
		{
			var before = $(this).data("before");
			var after = $(this).data("after");
			var href = $(this).data("href");
			var accion = $(this).data("accion");
			
			if( before!= undefined )
			{
				eval(before);
			}
			
			if(href != undefined )
			{
				cambiarVista( href );
			}
			
			if(accion != undefined)
			{
				if(accion.indexOf("menu") >= 0)
				{
					menu(accion);
				}
				else if(accion == "salir")
				{
					ajax({
						url: serverDomain + "/movil/logout",
						debeEvaluarSesion: false,
						done: function(data)
						{
							$("#menu-item-conocerte").hide();
							$("#menu-item-salir").hide();
							estaLogueado = false;
							inicializarPantallas();
							cambiarVista("ofertas");
						}
					});
				}
			}
			
			if(after != undefined )
			{
				eval(after);
			}
		});	
	}
	
	function agregarAColaDeReproduccion(pathDelArchivo)
	{
		var audio = new Audio(serverDomain + pathDelArchivo);
		audio.onerror = function(e){
			console.log("Error de audio: " + audio.src);
			console.log(mensajesDeErrorEnAudio[e.currentTarget.error.code]);
			estaReproduciendo = false;
			audios = new Array();
		};
		audio.onplay = function(){console.log("Reproduciendo: " + audio.src)};
		audios.push(audio);
		reproducirCola();
	}
	
	function reproducirCola()
	{
		if(audios.length > 0 && !estaReproduciendo)
		{
			estaReproduciendo = true;
			var audio = audios.shift();
			reproducir(audio, function()
			{
				estaReproduciendo = false;
				reproducirCola();
			});
		}
	}
	
	function reproducir(audio, callback)
	{
		audioEnReproduccion = audio;
		audioEnReproduccion.play();
		if(callback)
		{
			audioEnReproduccion.onended = callback;
		}
	}
	
	function ajax(param)
	{
		$.ajax({
			type: param.type != undefined ? param.type : "GET",
			contentType :param.contentType != undefined ? param.contentType : "application/x-www-form-urlencoded; charset=UTF-8",
			async: param.async != undefined ? param.async : true,
			dataType : "json",
			url : param.url,
			data : param.data != undefined ? param.data : ""
		})
		.done(function(data) 
		{
			console.log({ajax: param.url, params: param, respuesta: data});
			if(data.usuarioEstaLogueado)
			{
				estaLogueado = true;
				$(".contenedor-boton-ingresar").remove();
				$(".chat-icon-logueado").show();
				$(".header-chat-icon.no-logueado").hide();
				$("#menu-item-conocerte").show();
				$("#menu-item-salir").show();
				if(param.done != undefined)
				{
					param.done(data);
				}
				if(data.mostrarPopupdeOfertasNuevas)
				{
					$("#nuevasOfertas").modal('show');
				}
			}
			else if(data.usuarioEstaLogueado != undefined && estaLogueado && param.debeEvaluarSesion == undefined)
			{
				console.log(param.debeEvaluarSesion);
				$("#sesion-expirada").modal('show');
			}
			else if(param.done != undefined)
			{
				param.done(data);
			}
		})
		.fail(function(XMLHttpRequest, textStatus, textStatus) 
		{
			if( param.fail != undefined )
			{
				param.fail(XMLHttpRequest, textStatus, textStatus);
			}
		});
	}
	
	function getCookie(cname) 
	{
		var name = cname + "=";
		var ca = document.cookie.split(';');
		for(var i = 0; i <ca.length; i++) 
		{
			var c = ca[i];
			while (c.charAt(0)==' ') 
			{
				c = c.substring(1);
			}
			if (c.indexOf(name) == 0) {
				return c.substring(name.length,c.length);
			}
		}
		return "";
	}
	
	function setCookie(cname, cvalue, exdays) 
	{
		var d = new Date();
		d.setTime(d.getTime() + (exdays*24*60*60*1000));
		var expires = "expires="+ d.toUTCString();
		document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
	}
	</script>

</body>
</html>
